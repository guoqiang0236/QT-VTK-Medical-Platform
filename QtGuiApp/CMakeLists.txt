# ============================================================================
# é¡¹ç›®é…ç½®
# ============================================================================
cmake_minimum_required(VERSION 3.20)
project(QtGuiApp LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# ============================================================================
# æŸ¥æ‰¾ä¾èµ–åº“
# ============================================================================
find_package(Qt6 REQUIRED COMPONENTS 
    Core 
    Gui 
    Widgets 
    OpenGLWidgets 
    Quick 
    QuickWidgets
    LinguistTools
)

find_package(VTK REQUIRED)
if(NOT VTK_FOUND)
    message(FATAL_ERROR "VTK not found!")
endif()

# ============================================================================
# Qt è‡ªåŠ¨åŒ–å·¥å…·
# ============================================================================
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTOUIC ON)
set(CMAKE_AUTORCC ON)
set(CMAKE_AUTOUIC_SEARCH_PATHS ${CMAKE_CURRENT_SOURCE_DIR}/ui)

# ============================================================================
# æºæ–‡ä»¶æ”¶é›†
# ============================================================================
file(GLOB_RECURSE SRC_FILES CONFIGURE_DEPENDS
    "source/*.cpp"
    "source/*.h"
)

file(GLOB UI_FILES ${CMAKE_CURRENT_SOURCE_DIR}/ui/*.ui)

qt_add_resources(RESOURCES resources.qrc)

# ============================================================================
# ç¿»è¯‘æ–‡ä»¶é…ç½®
# ============================================================================
file(MAKE_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/translations)

set(TS_FILES
    ${CMAKE_CURRENT_SOURCE_DIR}/translations/QtGuiApp_zh_CN.ts
    ${CMAKE_CURRENT_SOURCE_DIR}/translations/QtGuiApp_en_US.ts
)

# âœ… ä½¿ç”¨ qt_create_translation ä»æºä»£ç æå–ç¿»è¯‘å­—ç¬¦ä¸²å¹¶ç”Ÿæˆ .ts æ–‡ä»¶
qt_create_translation(QM_FILES 
    ${CMAKE_CURRENT_SOURCE_DIR}/source  # æ‰«ææºä»£ç ç›®å½•
    ${CMAKE_CURRENT_SOURCE_DIR}/ui      # æ‰«æ UI æ–‡ä»¶ç›®å½•
    ${TS_FILES}
    OPTIONS -no-obsolete
)

# âœ… ä¿®å¤ï¼šä½¿ç”¨ qt_add_translation ä»£æ›¿ qt_create_translationï¼ˆæ›´ç¨³å®šï¼‰
# å¦‚æœä½ éœ€è¦ä»æºä»£ç æå–ç¿»è¯‘ï¼Œæ‰‹åŠ¨è¿è¡Œ lupdate
# qt_add_translation(QM_FILES ${TS_FILES})


# ============================================================================
# åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶
# ============================================================================
add_executable(QtGuiApp 
    ${SRC_FILES} 
    ${UI_FILES} 
    ${RESOURCES}
    ${QM_FILES}
    res/icon/apprc.rc
)

set_target_properties(QtGuiApp PROPERTIES
    WIN32_EXECUTABLE $<CONFIG:Release>
)

target_precompile_headers(QtGuiApp PRIVATE 
    "${CMAKE_CURRENT_SOURCE_DIR}/source/pch.h"
)

# ============================================================================
# åŒ…å«ç›®å½•
# ============================================================================
target_include_directories(QtGuiApp PRIVATE 
    ${VTK_INCLUDE_DIRS}
    ${CMAKE_CURRENT_SOURCE_DIR}/include
)

# ============================================================================
# é“¾æ¥ç›®å½•
# ============================================================================
target_link_directories(QtGuiApp PRIVATE 
    "${CMAKE_SOURCE_DIR}/lib"
)

# ============================================================================
# é“¾æ¥åº“
# ============================================================================
target_link_libraries(QtGuiApp PRIVATE
    Qt6::Core
    Qt6::Gui
    Qt6::Widgets
    Qt6::OpenGLWidgets
    Qt6::Quick
    Qt6::QuickWidgets
    
    VTK::GUISupportQt
    VTK::RenderingOpenGL2
    VTK::RenderingCore
    VTK::RenderingImage
    VTK::RenderingAnnotation
    VTK::RenderingVolume
    VTK::RenderingContextOpenGL2
    VTK::RenderingFreeType
    VTK::RenderingGL2PSOpenGL2
    VTK::RenderingVolumeOpenGL2
    VTK::InteractionStyle
    VTK::InteractionImage
    VTK::CommonCore
    VTK::CommonColor
    VTK::CommonDataModel
    VTK::IOImage
    VTK::ImagingCore
    VTK::ViewsContext2D
    VTK::FiltersGeneral
    VTK::FiltersGeometry
    VTK::FiltersModeling
    
    VtkUtil
    DcmtkUtil
    OpenCVUtil
    singleton
)

# ============================================================================
# VTK ä¾èµ–é…ç½®
# ============================================================================
if(TARGET VTK::moc)
    add_dependencies(QtGuiApp VTK::moc)
endif()

# ============================================================================
# ç¼–è¯‘é€‰é¡¹
# ============================================================================
if(NOT CMAKE_BUILD_TYPE STREQUAL "Debug")
    add_definitions(-DQT_NO_DEBUG_OUTPUT)
endif()


# è°ƒè¯•ï¼šè¾“å‡ºæœ€ç»ˆçš„ QM æ–‡ä»¶è·¯å¾„
message(STATUS "ğŸ¯ Translation files will be copied after build completes")

# ============================================================================
# å®‰è£…ç¿»è¯‘æ–‡ä»¶
# ============================================================================
install(FILES ${QM_FILES} DESTINATION translations)


# ============================================================================
# âœ… å¤åˆ¶ç¿»è¯‘æ–‡ä»¶åˆ°è¾“å‡ºç›®å½•ï¼ˆç§»åˆ°æœ€åï¼‰
# ============================================================================
# ç­‰å¾… QM æ–‡ä»¶ç”Ÿæˆåå†å¤åˆ¶
foreach(QM_FILE IN LISTS QM_FILES)
    get_filename_component(QM_FILENAME ${QM_FILE} NAME)
    
    # ä¸ºæ¯ä¸ªæ„å»ºé…ç½®å¤åˆ¶
    foreach(CONFIG IN ITEMS DEBUG RELEASE)
        string(TOUPPER ${CONFIG} CONFIG_UPPER)
        set(OUTPUT_DIR ${CMAKE_RUNTIME_OUTPUT_DIRECTORY_${CONFIG_UPPER}}/translations)
        
        add_custom_command(TARGET QtGuiApp POST_BUILD
            COMMAND ${CMAKE_COMMAND} -E make_directory ${OUTPUT_DIR}
            COMMAND ${CMAKE_COMMAND} -E copy_if_different
                ${QM_FILE}
                ${OUTPUT_DIR}/${QM_FILENAME}
            COMMENT "ğŸ“¦ Copying ${QM_FILENAME} to ${OUTPUT_DIR}"
            VERBATIM
        )
    endforeach()
    
endforeach()
